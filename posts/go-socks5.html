<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.114.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Go实现简单SOCKS5代理服务器"><meta itemprop=description content="实现SOCKS5代理服务器：UDP/TCP Proxy， No-Auth Method"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://s3.bmp.ovh/imgs/2023/06/27/181538d5761921f1.png"><meta itemprop=keywords content="go,socks5"><meta property="og:type" content="article"><meta property="og:title" content="Go实现简单SOCKS5代理服务器"><meta property="og:description" content="实现SOCKS5代理服务器：UDP/TCP Proxy， No-Auth Method"><meta property="og:image" content="https://s3.bmp.ovh/imgs/2023/06/27/181538d5761921f1.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://junfpy.github.io/posts/go-socks5.html"><meta property="og:site_name" content="昆仑"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Jun"><meta property="article:published_time" content="2023-06-26 17:00:13 +0800 CST"><meta property="article:modified_time" content="2023-06-26 18:25:00 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.382b0e2b33908c82ce34426618d1948914ff32308eaf6546a11b88ed0ef029ad.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"path":"go-socks5.html","permalink":"https://junfpy.github.io/posts/go-socks5.html","title":"Go实现简单SOCKS5代理服务器"}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Go实现简单SOCKS5代理服务器 - 昆仑</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>昆仑</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>和其光，同其尘</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><ul><li><a href=#一使用go的netlisten监听tcp请求>一、使用GO的net.listen监听tcp请求</a></li><li><a href=#二socks5协商过程>二、SOCKS5协商过程</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Jun src=/imgs/img-lazy-loading.gif data-src=https://s3.bmp.ovh/imgs/2023/06/27/181538d5761921f1.png><p class=site-author-name itemprop=name>Jun</p><div class=site-description itemprop=description></div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>3</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>1</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>3</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2023-06-26T17:00:13+08:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=8580></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=19></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2023-07-13T11:15:37+08:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://junfpy.github.io/posts/go-socks5.html><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="https://s3.bmp.ovh/imgs/2023/06/27/181538d5761921f1.png"><meta itemprop=name content="Jun"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Jun"><meta itemprop=description content></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Go实现简单SOCKS5代理服务器"><meta itemprop=description content="实现SOCKS5代理服务器：UDP/TCP Proxy， No-Auth Method"></span><header class=post-header><h1 class=post-title itemprop="name headline">Go实现简单SOCKS5代理服务器
<a href=https://github.com/user-name/repo-name/tree/branch-name/subdirectory-name/posts/go-socks5.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text title=发表于>发表于：</span>
<time title="创建时间：2023-06-26 17:00:13 +0800 CST" itemprop="dateCreated datePublished" datetime="2023-06-26 17:00:13 +0800 CST">2023-06-26</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i></span>
<span class=post-meta-item-text title=更新于>更新于：</span>
<time title=修改时间：2023-06-26T18:25:00+08:00 itemprop=dateModified datetime=2023-06-26T18:25:00+08:00>2023-06-26</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text title=分类于>分类于：</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/go itemprop=url rel=index><span itemprop=name>go</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span>
<span>1630</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>4分钟</span></span></div></div></header><div class=post-body itemprop=articleBody><p>简单实现SOCKS5代理服务器的部分功能：UDP/TCP Proxy， No-Auth Method</p><h3 id=一使用go的netlisten监听tcp请求>一、使用GO的net.listen监听tcp请求
<a class=header-anchor href=#%e4%b8%80%e4%bd%bf%e7%94%a8go%e7%9a%84netlisten%e7%9b%91%e5%90%actcp%e8%af%b7%e6%b1%82></a></h3><p>socks5.go</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>socks5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Server</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Run</span>() <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Socks5Server</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>IP</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Port</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Socks5Server</span>) <span style=color:#a6e22e>Run</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s:%d&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>IP</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Port</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>listener</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Listen</span>(<span style=color:#e6db74>&#34;tcp&#34;</span>, <span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>listener</span>.<span style=color:#a6e22e>Accept</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Connection failure from %s: %s&#34;</span>, <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>RemoteAddr</span>(), <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>handleConnection</span>(<span style=color:#a6e22e>conn</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;handle Connection failure from %s: %s&#34;</span>, <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>RemoteAddr</span>(), <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 处理请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleConnection</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Conn</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//协商过程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//请求过程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//转发过程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=二socks5协商过程>二、SOCKS5协商过程
<a class=header-anchor href=#%e4%ba%8csocks5%e5%8d%8f%e5%95%86%e8%bf%87%e7%a8%8b></a></h3><p>客户端向代理服务器发送代理请求，其中包含了代理的版本和认证方式：</p><figure class=wp-block-table><table><tbody><tr><td>VER</td><td>NMETHODS</td><td>METHODS</td></tr><tr><td>1</td><td>1</td><td>1 to 255</td></tr></tbody></table></figure><pre class=wp-block-code><code>VER：版本号
- X’04’：Socks4协议
- X’05’：Socks5协议
- NMETHODS：方法数目，该字段包含了METHODS中锁包含了方法识别码的个数
- METHOD ：方法列表</code></pre><p>代理服务器从给定的方法列表中选择一个方法并返回选择报文</p><figure class=wp-block-table><table><tbody><tr><td>VER</td><td>METHOD</td></tr><tr><td>1</td><td>1</td></tr></tbody></table></figure><p>如果 METHOD （方法）字段为 X’FF‘， 表示方法列表中的所有方法均不可用，客户端收到此信息必须关闭连接。</p><p>目前已定义方法如下：</p><ul><li>0x00 无需认证</li><li>0x01 GSSAPI</li><li>0x02 用户名/密码</li><li>0x03到0x7F IANA 指定</li><li>0x80到0xFE 为私有方法保留</li><li>0xFF 无可接受方法</code></pre></li></ul><p>auth.go</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>socks5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;io&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Method</span> = <span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MethodNoAuth</span>       <span style=color:#a6e22e>Method</span> = <span style=color:#ae81ff>0x00</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MethodGSSAPI</span>       <span style=color:#a6e22e>Method</span> = <span style=color:#ae81ff>0x01</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MethodPASSWORD</span>     <span style=color:#a6e22e>Method</span> = <span style=color:#ae81ff>0x02</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MethodNOACCEPTABLE</span> <span style=color:#a6e22e>Method</span> = <span style=color:#ae81ff>0xff</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 协商消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ClientAuthMessage</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Version</span>  <span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>NMethods</span> <span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Methods</span>  []<span style=color:#a6e22e>Method</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 接收客户端消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewClientAuthMessage</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Reader</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ClientAuthMessage</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>//io.ReadFull 从指定的读取器r读取到指定的缓冲区buf
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//返回指定缓冲区复制的字节数，如果读取的字节数小于指定缓冲区的长度，则返回错误
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//当且仅当没有读取字节时，返回的错误是“EOF”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//这里读取Version和NMethods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadFull</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>buf</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//socks5第一位是版本
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>!=</span> <span style=color:#a6e22e>Socks5Version</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>ErrVersionNotSupported</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//第二位是支持多少认证方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>nMethods</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>buf</span> = make([]<span style=color:#a6e22e>Method</span>, <span style=color:#a6e22e>nMethods</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadFull</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>buf</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ClientAuthMessage</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Version</span>:  <span style=color:#a6e22e>Socks5Version</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>NMethods</span>: <span style=color:#a6e22e>nMethods</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Methods</span>:  <span style=color:#a6e22e>buf</span>,
</span></span><span style=display:flex><span>	}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 服务端返回消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewServerAuthMessage</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Writer</span>, <span style=color:#a6e22e>method</span> <span style=color:#a6e22e>Method</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>byte</span>{<span style=color:#a6e22e>Socks5Version</span>, <span style=color:#a6e22e>method</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>buf</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ClientPasswordMessage</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Username</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Password</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>passwordAuthVersion</span> <span style=color:#66d9ef>byte</span> = <span style=color:#ae81ff>0x01</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>passwordAuthSucceeded</span> <span style=color:#66d9ef>byte</span> = <span style=color:#ae81ff>0x00</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>passwordAuthFailure</span>   <span style=color:#66d9ef>byte</span> = <span style=color:#ae81ff>0x01</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 用户名密码认证消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewPasswordAuthMessage</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Reader</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ClientPasswordMessage</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadFull</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>buf</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>version</span>, <span style=color:#a6e22e>ulen</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>version</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>passwordAuthVersion</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>ErrMethodVersionNotSupported</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//读取username
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> int(<span style=color:#a6e22e>ulen</span>) &gt; len(<span style=color:#a6e22e>buf</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>buf</span> = make([]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>ulen</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadFull</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>buf</span>[:<span style=color:#a6e22e>ulen</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>]); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>username</span> <span style=color:#f92672>:=</span> string(<span style=color:#a6e22e>buf</span>[:<span style=color:#a6e22e>ulen</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//读取password
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>plen</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>ulen</span>]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> int(<span style=color:#a6e22e>plen</span>) &gt; len(<span style=color:#a6e22e>buf</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>buf</span> = make([]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>plen</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadFull</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>buf</span>[:<span style=color:#a6e22e>plen</span>]); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>password</span> <span style=color:#f92672>:=</span> string(<span style=color:#a6e22e>buf</span>[:<span style=color:#a6e22e>plen</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ClientPasswordMessage</span>{<span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>password</span>}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewServerPasswordAuthMessage</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Writer</span>, <span style=color:#a6e22e>status</span> <span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>byte</span>{<span style=color:#a6e22e>passwordAuthVersion</span>, <span style=color:#a6e22e>status</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>buf</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>认证完成后，客户端告诉服务端需要代理访问哪一个远程服务器。</p><figure class=wp-block-table><table><tbody><tr><td>VER</td><td>CMD</td><td>RSV</td><td>ATYP</td><td>DST.ADDR</td><td>DST.PORT</td></tr><tr><td>1</td><td>1</td><td>0X00</td><td>1</td><td>Variable</td><td>2</td></tr></tbody></table></figure><p>VER是版本：0x05</p><p>CMD代表客户端请求的类型，值长度是1个字节，有三种类型</p><ul><li>CONNECT 0x01 TCP</li><li>BIND 0x02 建立多个连接通道</li><li>UDP ASSOCIATE 0x03 UDP</li></ul><p>RSV保留字，值长度为1个字节</p><p>ATYP代表请求的远程服务器地址类型，值长度1个字节，常用的就三种类型</p><ul><li>IP V4 address: 0x01 表示是一个IPV4地址</li><li>DOMAINNAME: 0x03 表示是一个域名（DOMAINNAME）</li><li>IP V6 address: 0x04 表示是一个IPV6地址（IP V6 address）</li></ul><p>DST.ADDR 代表远程服务器的地址，根据ATYP进行解析，值长度不定。</p><p>DST.PORT 代表远程服务器的端口，要访问哪个端口的意思，值长度2个字节。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>socks5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;io&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ClientRequestMessage</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Version</span>     <span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CMD</span>         <span style=color:#a6e22e>Command</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RSV</span>         <span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>AddressType</span> <span style=color:#a6e22e>AddressType</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ADDR</span>        <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PORT</span>        <span style=color:#66d9ef>uint16</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Command</span> <span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CommandConnect</span> <span style=color:#a6e22e>Command</span> = <span style=color:#ae81ff>0x01</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CommandBind</span>    <span style=color:#a6e22e>Command</span> = <span style=color:#ae81ff>0x02</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CommandUDP</span>     <span style=color:#a6e22e>Command</span> = <span style=color:#ae81ff>0x03</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AddressType</span> <span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>AddressTypeIPV4</span>   <span style=color:#a6e22e>AddressType</span> = <span style=color:#ae81ff>0x01</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>AddressTypeDomain</span> <span style=color:#a6e22e>AddressType</span> = <span style=color:#ae81ff>0x03</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>AddressTypeIPV6</span>   <span style=color:#a6e22e>AddressType</span> = <span style=color:#ae81ff>0x04</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewClientRequestMessage</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Reader</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ClientRequestMessage</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>//读取前四位
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadFull</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>buf</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>version</span>, <span style=color:#a6e22e>command</span>, <span style=color:#a6e22e>reserved</span>, <span style=color:#a6e22e>addressType</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>Command</span>(<span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>1</span>]), <span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>2</span>], <span style=color:#a6e22e>AddressType</span>(<span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>3</span>])
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>version</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>Socks5Version</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>ErrVersionNotSupported</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>command</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>CommandConnect</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>command</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>CommandBind</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>command</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>CommandUDP</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>ErrCommandNotSupported</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reserved</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>Socks5Reserved</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>ErrReservedNotSupported</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>addressType</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>AddressTypeIPV4</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>addressType</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>AddressTypeDomain</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>addressType</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>AddressTypeIPV6</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>ErrAddressTypeNotSupported</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>clientRequestMessage</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ClientRequestMessage</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Version</span>:     <span style=color:#a6e22e>version</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>CMD</span>:         <span style=color:#a6e22e>command</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>RSV</span>:         <span style=color:#a6e22e>reserved</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>AddressType</span>: <span style=color:#a6e22e>addressType</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//读取地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>addressType</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>AddressTypeIPV4</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadFull</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>buf</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>clientRequestMessage</span>.<span style=color:#a6e22e>ADDR</span> = <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IP</span>(<span style=color:#a6e22e>buf</span>).<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>AddressTypeDomain</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadFull</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>buf</span>[:<span style=color:#ae81ff>1</span>]); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>length</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>length</span> &gt; <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4len</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span> = make([]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>length</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadFull</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>buf</span>[:<span style=color:#a6e22e>length</span>]); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>clientRequestMessage</span>.<span style=color:#a6e22e>ADDR</span> = string(<span style=color:#a6e22e>buf</span>[:<span style=color:#a6e22e>length</span>])
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>AddressTypeIPV6</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>buf</span> = make([]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv6len</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadFull</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>buf</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>clientRequestMessage</span>.<span style=color:#a6e22e>ADDR</span> = <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IP</span>(<span style=color:#a6e22e>buf</span>).<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//读取port
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadFull</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>buf</span>[:<span style=color:#ae81ff>2</span>]); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>clientRequestMessage</span>.<span style=color:#a6e22e>PORT</span> = uint16(<span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>0</span>])<span style=color:#f92672>&lt;&lt;</span><span style=color:#ae81ff>8</span> <span style=color:#f92672>+</span> uint16(<span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>clientRequestMessage</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>接收解析客户端的请求后，请求目标网站，获得与目标网站的连接</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Conn</span>) (<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadWriteCloser</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewClientRequestMessage</span>(<span style=color:#a6e22e>conn</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>CMD</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>CommandBind</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>replyFailureMessage</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>RepCommandNotSupported</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>AddressType</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>AddressTypeIPV6</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>replyFailureMessage</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>RepAddressTypeNotSupported</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//请求目标网站
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>targetConn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#e6db74>&#34;tcp&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s:%d&#34;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>ADDR</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>PORT</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>replyFailureMessage</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>RepConnectionRefused</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>targetConn</span>.<span style=color:#a6e22e>LocalAddr</span>().(<span style=color:#f92672>*</span><span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>TCPAddr</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>targetConn</span>, <span style=color:#a6e22e>replySucceededMessage</span>(<span style=color:#a6e22e>conn</span>, byte(<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>AddressType</span>), <span style=color:#a6e22e>addr</span>.<span style=color:#a6e22e>IP</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>PORT</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>最后进行数据转发过程</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>forward</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadWriter</span>, <span style=color:#a6e22e>targetConn</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadWriteCloser</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>//io.Copy会阻塞，使用goroutine进行同时接收和发送数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>targetConn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Copy</span>(<span style=color:#a6e22e>targetConn</span>, <span style=color:#a6e22e>conn</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Copy</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>targetConn</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><footer class=post-footer><div class=post-tags><a href=/tags/go>go</a>
<a href=/tags/socks5>socks5</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/posts/static-map-initialization-in-go/ rel=next title="在Go中初始化大型static Maps"><i class="fa fa-chevron-left"></i> 在Go中初始化大型static Maps</a></div><div class="post-nav-prev post-nav-item"></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=waline-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>Jun</span></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://junfpy.github.io/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":null,"views":null},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.0","waline":{"cfg":{"comment":true,"emoji":["//unpkg.com/@waline/emojis@1.1.0/weibo","//unpkg.com/@waline/emojis@1.1.0/bilibili","//unpkg.com/@waline/emojis@1.1.0/tieba","//unpkg.com/@waline/emojis@1.1.0/alus","//unpkg.com/@waline/emojis@1.1.0/qq","//unpkg.com/@waline/emojis@1.1.0/tw-emoji"],"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick"],"serverurl":"https://waline-guw7ovgeu-jun-f.vercel.app","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.680e0e47c7981dad518ca98b339b740fe15a2c758661acd9fed327b98d0e7c92.js defer></script></body></html>